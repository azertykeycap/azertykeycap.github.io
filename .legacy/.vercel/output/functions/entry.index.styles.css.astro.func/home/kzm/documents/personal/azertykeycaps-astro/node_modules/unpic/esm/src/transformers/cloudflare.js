import { toUrl } from "../utils.js";
const cloudflareRegex = /https?:\/\/(?<host>[^\/]+)\/cdn-cgi\/image\/(?<transformations>[^\/]+)\/(?<path>.*)$/g;
const parseTransforms = (transformations) => Object.fromEntries(transformations.split(",").map((t) => t.split("=")));
const formatUrl = ({ host, transformations = {}, path, }) => {
    const transformString = Object.entries(transformations).map(([key, value]) => `${key}=${value}`).join(",");
    const pathSegments = [
        host,
        "cdn-cgi",
        "image",
        transformString,
        path,
    ].join("/");
    return `https://${pathSegments}`;
};
export const parse = (imageUrl) => {
    const url = toUrl(imageUrl);
    const matches = [...url.toString().matchAll(cloudflareRegex)];
    if (!matches.length) {
        throw new Error("Invalid Cloudflare URL");
    }
    const group = matches[0].groups || {};
    const { transformations: transformString, ...baseParams } = group;
    const { width, height, f, ...transformations } = parseTransforms(transformString);
    const base = formatUrl({ ...baseParams, transformations });
    return {
        base: url.toString(),
        width: Number(width) || undefined,
        height: Number(height) || undefined,
        format: f,
        cdn: "cloudflare",
        params: { ...group, transformations },
    };
};
export const generate = ({ base, width, height, format, params }) => {
    const parsed = parse(base.toString());
    const props = {
        transformations: {},
        ...parsed.params,
        ...params,
    };
    if (width) {
        props.transformations.width = width?.toString();
    }
    if (height) {
        props.transformations.height = height?.toString();
    }
    if (format) {
        props.transformations.f = format;
    }
    props.transformations.fit ||= "cover";
    return new URL(formatUrl(props));
};
export const transform = ({ url: originalUrl, width, height, format = "auto" }) => {
    const parsed = parse(originalUrl);
    if (!parsed) {
        throw new Error("Invalid Cloudflare URL");
    }
    const props = {
        ...parsed,
        width,
        height,
        format,
    };
    return generate(props);
};
